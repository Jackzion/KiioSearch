# èšåˆæœç´¢å¹³å°

# KiioSearch

## é¡¹ç›®ä»‹ç»

ä¸€ä¸ªèšåˆæœç´¢å¹³å°ï¼Œ**<mark>å¯ä»¥è®©ç”¨æˆ·åœ¨åŒä¸€ä¸ªå…¥å£ï¼ˆåŒä¸€ä¸ªé¡µé¢ï¼‰é›†ä¸­æœç´¢å‡ºä¸åŒçš„æ¥æºï¼Œä¸åŒç±»å‹çš„å†…å®¹</mark>**ã€‚

ç”¨æˆ·ï¼šæå‡ç”¨æˆ·æ£€ç´¢æ•ˆç‡ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

ä¼ä¸šï¼šæ— éœ€é’ˆå¯¹æ¯ä¸€ä¸ªé¡¹ç›®å»å¼€å‘ä¸€ä¸ªæœç´¢åŠŸèƒ½ï¼Œå½“ä½ æœ‰æ–°çš„å†…å®¹ï¼Œæ–°çš„ç½‘ç«™ï¼Œå¯ä»¥å¤ç”¨åŒä¸€å¥—æœç´¢ç³»ç»Ÿï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚

**æŠ€æœ¯æ ˆï¼š**

### å‰ç«¯

- Vue

- Ant Design Vue

- Lodash

### åç«¯

- Spring Boot

- MySQL

- Elasticsearch æœç´¢å¼•æ“

- æ•°æ®æŠ“å–(çˆ¬è™«)

- æ•°æ®åŒæ­¥

- - logstash
  
  - Canal

- Guava Retrying

- æ€ä¹ˆä¿è¯APIçš„ç¨³å®šæ€§

## ä¸šåŠ¡æµç¨‹

1. å¾—åˆ°å„ç§ä¸åŒåˆ†ç±»çš„é¡µé¢

2. æä¾›ä¸€ä¸ªæœç´¢é¡µé¢ï¼ˆå•ä¸€æœç´¢ + èšåˆæœç´¢ï¼‰

3. (ä¼˜åŒ–ã€‚ã€‚ã€‚å…³é”®è¯ä¼˜åŒ–ï¼Œé˜²æŠ–èŠ‚æµ

## æµç¨‹å›¾

ä»¥å‰çš„å•ä¸€ä¸šåŠ¡æœç´¢ï¼šç”¨æˆ·è¦åˆ°ä¸åŒç½‘ç«™è·å–ä¸åŒèµ„æºï¼Œä¼ä¸šä¹Ÿè¦æ­æ„ä¸åŒçš„backend

![](C:\Users\Ziio\AppData\Roaming\marktext\images\2024-05-31-17-27-30-image.png)

NOW KIIO SEARCH èšåˆæœç´¢å¹³å°ï¼š

![](C:\Users\Ziio\AppData\Roaming\marktext\images\2024-05-31-17-31-12-image.png)

### ç¬¬ä¸€æœŸ

1. é¡¹ç›®åˆå§‹åŒ– ï¼ˆå‰ç«¯ï¼Œåç«¯ï¼‰

2. å‰ç«¯æœç´¢é¡µé¢

3. åç«¯æœç´¢æ¥å£

#### é¡¹ç›®åˆå§‹åŒ–

å‰ç«¯ï¼šè„šæ‰‹æ¶æ­æ„ ï¼š ant design vue --- [å¿«é€Ÿä¸Šæ‰‹ - Ant Design Vue (antdv.com)](https://www.antdv.com/docs/vue/getting-started-cn)

åç«¯ï¼š spring - init template

http://localhost:8101/api/doc.html#/home

#### tag å¯¼èˆªæ  æ”¹é€  è·¯ç”±é¡µé¢åŒæ­¥

url <-------> page 

1. pageåŒæ­¥åˆ°url ï¼š ç”¨æˆ·æœç´¢ï¼Œç‚¹tag æ“ä½œçš„æ—¶å€™æ”¹å˜urlåœ°å€ã€‚ path , query 

2. urlåŒæ­¥åˆ°page ï¼šroute.query , route.param ã€‚ã€‚

#### å¼•å…¥ Axios ï¼Œ é…æ‹¦æˆªå™¨ã€‚ã€‚

#### [æ‹¦æˆªå™¨ | Axiosä¸­æ–‡æ–‡æ¡£ | Axiosä¸­æ–‡ç½‘ (axios-http.cn)](https://www.axios-http.cn/docs/interceptors)

#### å¿«é€Ÿåˆ›å»º post ï¼Œimgae ï¼Œ user List é€šè¿‡ props ä¼ å‚ã€‚

# ç¬¬äºŒæœŸ

1. è·å–å¤šç§ä¸åŒç±»å‹çš„æ•°æ®æº
   1. æ–‡ç« ï¼ˆå†…éƒ¨ï¼‰
   2. ç”¨æˆ·ï¼ˆå†…éƒ¨ï¼‰
   3. å›¾ç‰‡ï¼ˆå¤–éƒ¨ï¼Œä¸æ˜¯æˆ‘ä»¬è‡ªå·±çš„é¡¹ç›®ã€è‡ªå·±çš„ç”¨æˆ·äº§ç”Ÿçš„æ•°æ®ï¼‰
2. å‰åç«¯å•ç‹¬çš„æœç´¢æ¥å£è”è°ƒï¼Œè·‘é€šæ•´ä¸ªé¡µé¢
3. åˆ†æç°æœ‰é¡¹ç›®çš„é—®é¢˜ => ä¼˜åŒ–ï¼Œèšåˆæ¥å£çš„å¼€å‘
4. ï¼ˆæå‰å®‰è£… ESï¼‰

### æ•°æ®æºè·å–(çˆ¬è™« ---> post ï¼Œimgae )ï¼š

- ç›´æ¥è¯·æ±‚æ•°æ®æ¥å£ï¼ˆæœ€æ–¹ä¾¿ï¼‰HttpClientã€OKHttpã€RestTemplateã€Hutoolï¼ˆ[https://hutool.cnï¼‰](https://hutool.cn%EF%BC%89)

- ç­‰ç½‘é¡µæ¸²æŸ“å‡ºæ˜æ–‡å†…å®¹åï¼Œä»å‰ç«¯é¡µé¢çš„å†…å®¹æŠ“å–

- æœ‰ä¸€äº›ç½‘ç«™å¯èƒ½æ˜¯åŠ¨æ€è¯·æ±‚çš„ï¼Œä»–ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰çš„æ•°æ®ï¼Œè€Œæ˜¯è¦ä½ ç‚¹æŸä¸ªæŒ‰é’®ã€è¾“å…¥æŸä¸ªéªŒè¯ç æ‰ä¼šæ˜¾ç¤ºå‡ºæ•°æ®ã€‚=> æ— å¤´æµè§ˆå™¨ï¼šjavaï¼šseleniumï¼›node.jsï¼špuppeteer

#### post è·å– ï¼ˆæ¥å£çˆ¬è™«ï¼‰ï¼šHutool [https://hutool.cnï¼‰](https://hutool.cn%EF%BC%89)

æŠ“å–ï¼š[ç¼–ç¨‹å¯¼èˆª - åšæ‚¨ç¼–ç¨‹è·¯ä¸Šçš„å¯¼èˆªå‘˜](https://www.code-nav.cn/learn/passage)

è·å–åˆ°æ–‡ç« åè¦å…¥åº“ï¼ˆå®šæ—¶è·å–æˆ–è€…åªè·å–ä¸€æ¬¡ï¼‰ï¼Œ**ç¦»çº¿æŠ“å–

#### image è·å–ï¼ˆæ¥å£çˆ¬è™«ï¼‰[jsoup: Java HTML parser, built for HTML editing, cleaning, scraping, and XSS safety](https://jsoup.org/)

æŠ“å–ï¼šbing image

å®æ—¶è·å–ï¼Œå®ç°æ¥å£ï¼Œæ¯æ¬¡è¯·æ±‚å°±è½¬å‘åˆ° bing request ,ä¸åœ¨æ•°æ®åº“å­˜å‚¨

# ç¬¬ä¸‰æœŸ

1. èšåˆæ¥å£ä¼˜åŒ–ï¼ˆæ”¯æŒå‰ç«¯æ›´çµæ´»çš„æ•°æ®ï¼‰
2. ä» 0 å¼€å§‹å­¦ä¹  Elastic Stackï¼ˆElasticsearchï¼‰
3. å­¦ä¹ æ•°æ®åŒæ­¥ï¼Œæ€ä¹ˆæŠŠä¸€ä¸ªæ•°æ®åº“å†…çš„æ•°æ®åŒæ­¥åˆ°å…¶ä»–æ•°æ®åº“

## èšåˆæ¥å£ä¼˜åŒ–

æ€ä¹ˆæ ·èƒ½è®©å‰ç«¯åˆèƒ½ä¸€æ¬¡æœå‡ºæ‰€æœ‰æ•°æ®ï¼Œåˆèƒ½å¤Ÿåˆ†åˆ«è·å–æŸä¸€ç±»æ•°æ®ï¼ˆæ¯”å¦‚åˆ†é¡µåœºæ™¯ï¼‰

æ–°å¢ï¼šå‰ç«¯ä¼  type è°ƒç”¨åç«¯åŒä¸€ä¸ªæ¥å£, åç«¯æ ¹æ® type è°ƒç”¨ä¸åŒçš„ service æŸ¥è¯¢
æ¯”å¦‚ï¼štype = user => userService.query

1. å¦‚æœ type ä¸ºç©ºï¼Œé‚£ä¹ˆæœç´¢å‡ºæ‰€æœ‰çš„æ•°æ®
2. å¦‚æœ type ä¸ä¸ºç©º
   1. å¦‚æœ type åˆæ³•ï¼Œé‚£ä¹ˆæŸ¥å‡ºå¯¹åº”æ•°æ®
   2. å¦åˆ™æŠ¥é”™

ä¼˜åŒ–é—®é¢˜ï¼Ÿ --- åç«¯ if è¯­å¥å¤ªå¤š ,

### é—¨é¢æ¨¡å¼

å¸®åŠ©æˆ‘ä»¬ç”¨æˆ·ï¼ˆå®¢æˆ·ç«¯ï¼‰å»æ›´è½»æ¾çš„å®ç°åŠŸèƒ½ï¼Œä¸éœ€è¦å…³å¿ƒé—¨é¢èƒŒåçš„ç»†èŠ‚ã€‚

èšåˆæœç´¢ç±»ä¸šåŠ¡åŸºæœ¬å°±æ˜¯é—¨é¢æ¨¡å¼ï¼šå³å‰ç«¯ä¸ç”¨å…³å¿ƒåç«¯ä»å“ªé‡Œã€æ€ä¹ˆå»å–ä¸åŒæ¥æºã€æ€ä¹ˆå»èšåˆä¸åŒæ¥æºçš„æ•°æ®ï¼Œæ›´æ–¹ä¾¿çš„è·å–åˆ°å†…å®¹ã€‚

è¡¥å……ï¼šå½“è°ƒç”¨ä½ ç³»ç»Ÿï¼ˆæ¥å£ï¼‰çš„å®¢æˆ·ç«¯è§‰å¾—éº»çƒ¦çš„æ—¶å€™ï¼Œä½ å°±åº”è¯¥æ€è€ƒï¼Œæ˜¯ä¸æ˜¯å¯ä»¥æŠ½è±¡ä¸€ä¸ªé—¨é¢äº†ã€‚

#### å›¾è§£

![image20230325120636868](https://typora-1313423481.cos.ap-guangzhou.myqcloud.com/typora/image-20230325120636868.png)

#### è§£å†³ï¼šå°† æœç´¢ type çš„ if è¯­å¥ ï¼Œæå‡ºä¸€å±‚ ï¼Œä½œä¸ºé—¨é¢ã€‚

ä½†åˆä¼šå¼•å‡ºæ–°é—®é¢˜ --- æ‹“å±•æ€§å·® ï¼Œ æ–°çš„ type ä¼šç»Ÿä¸€æ·»åŠ ä¿®æ”¹å¤šä¸ªæ¨¡å—

### é€‚é…å™¨æ¨¡å¼

1. å®šåˆ¶ç»Ÿä¸€çš„æ•°æ®æºæ¥å…¥è§„èŒƒï¼ˆæ ‡å‡†ï¼‰ï¼šä»€ä¹ˆæ•°æ®æºå…è®¸æ¥å…¥ï¼Ÿä½ çš„æ•°æ®æºæ¥å…¥æ—¶è¦æ»¡è¶³ä»€ä¹ˆè¦æ±‚ï¼Ÿè¦åšä»€ä¹ˆäº‹æƒ…ï¼Ÿ

**ä»»ä½•æ¥å…¥æˆ‘ä»¬ç³»ç»Ÿçš„æ•°æ®ï¼Œå®ƒå¿…é¡»è¦èƒ½å¤Ÿæ ¹æ®å…³é”®è¯æœç´¢ã€å¹¶ä¸”æ”¯æŒåˆ†é¡µæœç´¢**

å£°æ˜æ¥å£æ¥å®šä¹‰è§„èŒƒ

2. å‡å¦‚æˆ‘ä»¬çš„æ•°æ®æºå·²ç»æ”¯æŒäº†æœç´¢ï¼Œä½†æ˜¯åŸæœ‰çš„æ–¹æ³•å‚æ•°å’Œæˆ‘ä»¬çš„è§„èŒƒä¸ä¸€è‡´ï¼Œæ€ä¹ˆåŠï¼Ÿ

é€‚é…å™¨æ¨¡å¼çš„ä½œç”¨ï¼šé€šè¿‡è½¬æ¢ï¼Œè®©ä¸¤ä¸ªç³»ç»Ÿèƒ½å¤Ÿå®Œæˆå¯¹æ¥

### æ³¨å†Œå™¨æ¨¡å¼ï¼ˆæœ¬è´¨ä¹Ÿæ˜¯å•ä¾‹ï¼‰

æèµ·é€šè¿‡ä¸€ä¸ª map æˆ–è€…å…¶ä»–ç±»å‹å­˜å‚¨å¥½åé¢éœ€è¦è°ƒç”¨çš„å¯¹è±¡ã€‚

#### è§£å†³ï¼šä½¿ç”¨ä¸¤æ¨¡å¼ï¼Œå¯¹ dataSourceè¿›è¡ŒæŠ½è±¡ ï¼Œ ç„¶å é€šè¿‡ mapæ³¨å†Œä¸åŒç±»å‹çš„ dataSource è¿›è¡Œæ³¨å†Œå’Œä½¿ç”¨ã€‚ã€‚ç±»ä¼¼äº BeanRegister

## æœç´¢ä¼˜åŒ–

é—®é¢˜ï¼šæœç´¢ä¸å¤Ÿçµæ´»ï¼ï¼ï¼

æ¯”å¦‚æœâ€œé±¼çš®rapperâ€ æ— æ³•æœåˆ° â€œé±¼çš®æ˜¯rapperâ€ï¼Œå› ä¸ºæ•°æ®åº“çš„ like æ˜¯åŒ…å«æŸ¥è¯¢ã€‚

éœ€è¦åˆ†è¯

## Elastic Stackï¼ˆä¸€å¥—æŠ€æœ¯æ ˆï¼‰

å®˜ç½‘ï¼š[Elastic â€” The Search AI Company | Elastic](https://www.elastic.co/cn/)

åŒ…å«äº†æ•°æ®çš„æ•´åˆ => æå– => å­˜å‚¨ => ä½¿ç”¨ï¼Œä¸€æ•´å¥—ï¼

beatsï¼šä»å„ç§ä¸åŒç±»å‹çš„æ–‡ä»¶ / åº”ç”¨æ¥ é‡‡é›†æ•°æ® a,b,c,d,e,aa,bb,cc

Logstashï¼šä»å¤šä¸ªé‡‡é›†å™¨æˆ–æ•°æ®æºæŠ½å– / è½¬æ¢æ•°æ®ï¼Œå‘ es è¾“é€ aa,bb,cc

elasticsearchï¼šå­˜å‚¨ã€æŸ¥è¯¢æ•°æ®

kibanaï¼šå¯è§†åŒ– es çš„æ•°æ®

### å®‰è£… ES

elasticsearchï¼š[Set up Elasticsearch | Elasticsearch Guide [7.17] | Elastic](https://www.elastic.co/guide/en/elasticsearch/reference/7.17/setup.html)

kibanaï¼š[Kibanaâ€”your window into Elastic | Kibana Guide [7.17] | Elastic](https://www.elastic.co/guide/en/kibana/7.17/introduction.html)

**åªè¦æ˜¯ä¸€å¥—æŠ€æœ¯ï¼Œæ‰€æœ‰ç‰ˆæœ¬å¿…é¡»ä¸€è‡´ï¼ï¼ï¼æ­¤å¤„ç”¨ 7.17

## ç¬¬å››æœŸ

1. ç»§ç»­è®² ElasticStack çš„æ¦‚å¿µ
2. å­¦ä¹ ç”¨ Java æ¥è°ƒç”¨ Elasticsearch
3. ä½¿ç”¨ ES æ¥ä¼˜åŒ–èšåˆæœç´¢æ¥å£
4. å·²æœ‰çš„ DB çš„æ•°æ®å’Œ ES æ•°æ®åŒæ­¥ï¼ˆå¢é‡ã€å…¨é‡ï¼›å®æ—¶ã€éå®æ—¶ï¼‰
5. jmeter å‹åŠ›æµ‹è¯•
6. ä¿éšœæ¥å£ç¨³å®šæ€§
7. å…¶ä»–çš„æ‰©å±•æ€è·¯

### åˆ†è¯å™¨

[Test an analyzer | Elasticsearch Guide [7.17] | Elastic](https://www.elastic.co/guide/en/elasticsearch/reference/7.17/test-analyzer.html)

### IK åˆ†è¯å™¨ï¼ˆES æ’ä»¶ï¼‰

ä¸­æ–‡å‹å¥½ï¼š[GitHub - infinilabs/analysis-ik: ğŸšŒ The IK Analysis plugin integrates Lucene IK analyzer into Elasticsearch and OpenSearch, support customized dictionary.](https://github.com/medcl/elasticsearch-analysis-ik)

ä¸‹è½½åœ°å€ï¼š[https://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v7.17.7ï¼ˆæ³¨æ„ç‰ˆæœ¬ä¸€è‡´ï¼‰](https://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v7.17.7%EF%BC%88%E6%B3%A8%E6%84%8F%E7%89%88%E6%9C%AC%E4%B8%80%E8%87%B4%EF%BC%89)

æ€è€ƒï¼šæ€ä¹ˆæ ·è®© ik æŒ‰è‡ªå·±çš„æƒ³æ³•åˆ†è¯ï¼Ÿ

å›ç­”ï¼šè‡ªå®šä¹‰è¯å…¸

#### æ­¥éª¤

1. åœ¨ elasticsearch-7.17.9 ç›®å½•ä¸‹æ–°å»º plugins ç›®å½•
2. åœ¨ plugins ç›®å½•ä¸‹æ–°å»º ik ç›®å½•
3. å°†ä¸‹è½½çš„ zip åŒ…è§£å‹åˆ° ik ç›®å½•ä¸‹
4. å°† elasticsearch-analysis-ik-7.17.7 ç›®å½•ä¸­çš„æ‰€æœ‰å†…å®¹ç§»åˆ° ik ç›®å½•ä¸‹

### ES è°ƒç”¨æ–¹å¼

1. HTTP Restful è°ƒç”¨
2. kibana æ“ä½œï¼ˆdev toolsï¼‰
3. å®¢æˆ·ç«¯æ“ä½œï¼ˆJavaï¼‰

### Java æ“ä½œ ES

3 ç§ï¼š

1. ES å®˜æ–¹çš„ Java API

[Introduction | Elasticsearch Java API Client [7.17] | Elastic](https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/introduction.html)

å¿«é€Ÿå¼€å§‹ï¼š[Connecting | Elasticsearch Java API Client [7.17] | Elastic](https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/connecting.html)

2. ES ä»¥å‰çš„å®˜æ–¹ Java APIï¼ŒHighLeavelRestClientï¼ˆå·²åºŸå¼ƒï¼Œä¸å»ºè®®ç”¨ï¼‰

3. Spring Data Elasticsearch

spring-data ç³»åˆ—ï¼šspring æä¾›çš„æ“ä½œæ•°æ®åº“çš„æ¡†æ¶

spring-data-redisï¼šæ“ä½œ redis çš„ä¸€å¥—æ–¹æ³•

spring-data-mongodbï¼šæ“ä½œ mongodbçš„ä¸€å¥—æ–¹æ³•

spring-data-elasticsearchï¼šæ“ä½œ elasticsearch çš„ä¸€å¥—æ–¹æ³•

å®˜æ–¹æ–‡æ¡£ï¼š[Spring Data Elasticsearch - Reference Documentation](https://docs.spring.io/spring-data/elasticsearch/docs/4.4.10/reference/html/)

è‡ªå®šä¹‰æ–¹æ³•ï¼š

ç”¨æˆ·å¯ä»¥æŒ‡å®šæ¥å£çš„æ–¹æ³•åç§°ï¼Œæ¡†æ¶å¸®ä½ è‡ªåŠ¨ç”ŸæˆæŸ¥è¯¢

## ES å»ºç«‹ Post è¡¨

#### ES Mappingï¼š

idï¼ˆå¯ä»¥ä¸æ”¾åˆ°å­—æ®µè®¾ç½®é‡Œï¼‰

ES ä¸­ï¼Œå°½é‡å­˜æ”¾éœ€è¦ç”¨æˆ·ç­›é€‰ï¼ˆæœç´¢ï¼‰çš„æ•°æ®

aliasesï¼šåˆ«åï¼ˆä¸ºäº†åç»­æ–¹ä¾¿æ•°æ®è¿ç§»ï¼‰

å­—æ®µç±»å‹æ˜¯ textï¼Œè¿™ä¸ªå­—æ®µæ˜¯å¯è¢«åˆ†è¯çš„ã€å¯æ¨¡ç³ŠæŸ¥è¯¢çš„ï¼›è€Œå¦‚æœæ˜¯ keywordï¼Œåªèƒ½å®Œå…¨åŒ¹é…ã€ç²¾ç¡®æŸ¥è¯¢ã€‚

analyzerï¼ˆå­˜å‚¨æ—¶ç”Ÿæ•ˆçš„åˆ†è¯å™¨ï¼‰ï¼šç”¨ ik_max_wordï¼Œæ‹†çš„æ›´ç¢ã€ç´¢å¼•æ›´å¤šï¼Œæ›´æœ‰å¯èƒ½è¢«æœå‡ºæ¥

search_analyzerï¼ˆæŸ¥è¯¢æ—¶ç”Ÿæ•ˆçš„åˆ†è¯å™¨ï¼‰ï¼šç”¨ ik_smartï¼Œæ›´åå‘äºç”¨æˆ·æƒ³æœçš„åˆ†è¯

å¦‚æœæƒ³è¦è®© text ç±»å‹çš„åˆ†è¯å­—æ®µä¹Ÿæ”¯æŒç²¾ç¡®æŸ¥è¯¢ï¼Œå¯ä»¥åˆ›å»º keyword ç±»å‹çš„å­å­—æ®µï¼š

```json
"fields": {
      "keyword": {
        "type": "keyword",
        "ignore_above": 256 // è¶…è¿‡å­—ç¬¦æ•°åˆ™å¿½ç•¥æŸ¥è¯¢
  }
```

å»ºè¡¨ç»“æ„ï¼š

```json
PUT post_v1
{
  "aliases": {
    "post": {}
  },
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "content": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "tags": {
        "type": "keyword"
      },
      "userId": {
        "type": "keyword"
      },
      "createTime": {
        "type": "date"
      },
      "updateTime": {
        "type": "date"
      },
      "isDelete": {
        "type": "keyword"
      }
    }
  }
}
```

## Java ä½¿ç”¨ spring data API å¢åˆ æ”¹æŸ¥

#### æ ¹æ® DSL æ„é€  query

æŸ¥è¯¢ DSLï¼š

å‚è€ƒæ–‡æ¡£ï¼š

[Query and filter context | Elasticsearch Guide [7.17] | Elastic](https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-filter-context.html)

[Boolean query | Elasticsearch Guide [7.17] | Elastic](https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl-bool-query.html)

```json
GET post/_search
{
  "query": { 
    "bool": { // ç»„åˆæ¡ä»¶
      "must": [ // å¿…é¡»éƒ½æ»¡è¶³
        { "match": { "title":   "ziio"        }}, // match æ¨¡ç³ŠæŸ¥è¯¢
        { "match": { "content":   "girls band cry "        }}
      ],
      "filter": [ 
        { "term":  { "status": "published" }}, // term ç²¾ç¡®æŸ¥è¯¢
        { "range": { "publish_date": { "gte": "2015-01-01" }}} // range èŒƒå›´æŸ¥è¯¢
      ]
    }
  }
}
```

```json
POST _search
{
  "query": {
    "bool" : { // bool query  ç»„åˆå¤šä¸ªå­æŸ¥è¯¢
      "must" : { // å¿…é¡»æ¡ä»¶
        "term" : { "user.id" : "kimchy" } // ç²¾ç¡®æŸ¥è¯¢
      },
      "filter": {// å¿…é¡»æ¡ä»¶ ï¼Œ ä½†filter ä¸å½±å“è¯„åˆ†
        "term" : { "tags" : "production" } // ç²¾ç¡®æŸ¥è¯¢
      },
      "must_not" : {// å¿…é¡»ä¸åŒ…å«æ¡ä»¶
        "range" : { // èŒƒå›´æŸ¥è¯¢
          "age" : { "gte" : 10, "lte" : 20 }
        }
      },
      "should" : [ // åº”è¯¥åŒ…å« ï¼Œ æ ¹æ®minimum è®¾ç½®æ¡ä»¶æœ€å°ä¸ªæ•°
        { "term" : { "tags" : "env1" } }, // ç²¾ç¡®æŸ¥è¯¢
        { "term" : { "tags" : "deployed" } } // ç²¾ç¡®æŸ¥è¯¢
      ],
      "minimum_should_match" : 1,
      "boost" : 1.0
    }
  }
}
```

### è½¬æ¢ä¸º java ä»£ç 

```java
    public Page<Post> searchFromEs(PostQueryRequest postQueryRequest) {
        Long id = postQueryRequest.getId();
        Long notId = postQueryRequest.getNotId();
        String searchText = postQueryRequest.getSearchText();
        String title = postQueryRequest.getTitle();
        String content = postQueryRequest.getContent();
        List<String> tagList = postQueryRequest.getTags();
        List<String> orTagList = postQueryRequest.getOrTags();
        Long userId = postQueryRequest.getUserId();
        // es èµ·å§‹é¡µä¸º 0
        long current = postQueryRequest.getCurrent() - 1;
        long pageSize = postQueryRequest.getPageSize();
        String sortField = postQueryRequest.getSortField();
        String sortOrder = postQueryRequest.getSortOrder();
        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();
        // è¿‡æ»¤
        boolQueryBuilder.filter(QueryBuilders.termQuery("isDelete", 0));
        if (id != null) {
            boolQueryBuilder.filter(QueryBuilders.termQuery("id", id));
        }
        if (notId != null) {
            boolQueryBuilder.mustNot(QueryBuilders.termQuery("id", notId));
        }
        if (userId != null) {
            boolQueryBuilder.filter(QueryBuilders.termQuery("userId", userId));
        }
        // å¿…é¡»åŒ…å«æ‰€æœ‰æ ‡ç­¾
        if (CollUtil.isNotEmpty(tagList)) {
            for (String tag : tagList) {
                boolQueryBuilder.filter(QueryBuilders.termQuery("tags", tag));
            }
        }
        // åŒ…å«ä»»ä½•ä¸€ä¸ªæ ‡ç­¾å³å¯
        if (CollUtil.isNotEmpty(orTagList)) {
            BoolQueryBuilder orTagBoolQueryBuilder = QueryBuilders.boolQuery();
            for (String tag : orTagList) {
                orTagBoolQueryBuilder.should(QueryBuilders.termQuery("tags", tag));
            }
            orTagBoolQueryBuilder.minimumShouldMatch(1);
            boolQueryBuilder.filter(orTagBoolQueryBuilder);
        }
        // æŒ‰å…³é”®è¯æ£€ç´¢
        if (StringUtils.isNotBlank(searchText)) {
            boolQueryBuilder.should(QueryBuilders.matchQuery("title", searchText));
            boolQueryBuilder.should(QueryBuilders.matchQuery("description", searchText));
            boolQueryBuilder.should(QueryBuilders.matchQuery("content", searchText));
            boolQueryBuilder.minimumShouldMatch(1);
        }
        // æŒ‰æ ‡é¢˜æ£€ç´¢
        if (StringUtils.isNotBlank(title)) {
            boolQueryBuilder.should(QueryBuilders.matchQuery("title", title));
            boolQueryBuilder.minimumShouldMatch(1);
        }
        // æŒ‰å†…å®¹æ£€ç´¢
        if (StringUtils.isNotBlank(content)) {
            boolQueryBuilder.should(QueryBuilders.matchQuery("content", content));
            boolQueryBuilder.minimumShouldMatch(1);
        }
        // æ’åº
        SortBuilder<?> sortBuilder = SortBuilders.scoreSort();
        if (StringUtils.isNotBlank(sortField)) {
            sortBuilder = SortBuilders.fieldSort(sortField);
            sortBuilder.order(CommonConstant.SORT_ORDER_ASC.equals(sortOrder) ? SortOrder.ASC : SortOrder.DESC);
        }
        // åˆ†é¡µ
        PageRequest pageRequest = PageRequest.of((int) current, (int) pageSize);
        // æ„é€ æŸ¥è¯¢
        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder().withQuery(boolQueryBuilder)
                .withPageable(pageRequest).withSorts(sortBuilder).build();
        SearchHits<PostEsDTO> searchHits = elasticsearchRestTemplate.search(searchQuery, PostEsDTO.class);
        Page<Post> page = new Page<>();
        page.setTotal(searchHits.getTotalHits());
        List<Post> resourceList = new ArrayList<>();
        // æŸ¥å‡ºç»“æœåï¼Œä» db è·å–æœ€æ–°åŠ¨æ€æ•°æ®ï¼ˆæ¯”å¦‚ç‚¹èµæ•°ï¼‰
        if (searchHits.hasSearchHits()) {
            List<SearchHit<PostEsDTO>> searchHitList = searchHits.getSearchHits();
            List<Long> postIdList = searchHitList.stream().map(searchHit -> searchHit.getContent().getId())
                    .collect(Collectors.toList());
            List<Post> postList = baseMapper.selectBatchIds(postIdList);
            if (postList != null) {
                Map<Long, List<Post>> idPostMap = postList.stream().collect(Collectors.groupingBy(Post::getId));
                postIdList.forEach(postId -> {
                    if (idPostMap.containsKey(postId)) {
                        resourceList.add(idPostMap.get(postId).get(0));
                    } else {
                        // ä» es æ¸…ç©º db å·²ç‰©ç†åˆ é™¤çš„æ•°æ®
                        String delete = elasticsearchRestTemplate.delete(String.valueOf(postId), PostEsDTO.class);
                        log.info("delete post {}", delete);
                    }
                });
            }
        }
        page.setRecords(resourceList);
        return page;
    }
```

## Elastic æ²¡æœ‰æ•°æ® ï¼Œmysql è¿›è¡Œæ•°æ®åŒæ­¥

## æ•°æ®åŒæ­¥

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœåšæŸ¥è¯¢æœç´¢åŠŸèƒ½ï¼Œä½¿ç”¨ ES æ¥æ¨¡ç³Šæœç´¢ï¼Œä½†æ˜¯æ•°æ®æ˜¯å­˜æ”¾åœ¨æ•°æ®åº“ MySQL é‡Œçš„ï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦æŠŠ MySQL ä¸­çš„æ•°æ®å’Œ ES è¿›è¡ŒåŒæ­¥ï¼Œä¿è¯æ•°æ®ä¸€è‡´ï¼ˆä»¥ MySQL ä¸ºä¸»ï¼‰ã€‚

MySQL => ES ï¼ˆå•å‘ï¼‰

é¦–æ¬¡å®‰è£…å®Œ ESï¼ŒæŠŠ MySQL æ•°æ®å…¨é‡åŒæ­¥åˆ° ES é‡Œï¼Œå†™ä¸€ä¸ªå•æ¬¡è„šæœ¬

4 ç§å¢é‡æ–¹å¼ï¼Œå…¨é‡åŒæ­¥ï¼ˆé¦–æ¬¡ï¼‰+ å¢é‡åŒæ­¥ï¼ˆæ–°æ•°æ®ï¼‰ï¼š

1. å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚ 1 åˆ†é’Ÿ 1 æ¬¡ï¼Œæ‰¾åˆ° MySQL ä¸­è¿‡å»å‡ åˆ†é’Ÿå†…ï¼ˆè‡³å°‘æ˜¯å®šæ—¶å‘¨æœŸçš„ 2 å€ï¼‰å‘ç”Ÿæ”¹å˜çš„æ•°æ®ï¼Œç„¶åæ›´æ–°åˆ° ESã€‚

â€‹ ä¼˜ç‚¹ï¼šç®€å•æ˜“æ‡‚ã€å ç”¨èµ„æºå°‘ã€ä¸ç”¨å¼•å…¥ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶

â€‹ ç¼ºç‚¹ï¼šæœ‰æ—¶é—´å·®

â€‹ åº”ç”¨åœºæ™¯ï¼šæ•°æ®çŸ­æ—¶é—´å†…ä¸åŒæ­¥å½±å“ä¸å¤§ã€æˆ–è€…æ•°æ®å‡ ä¹ä¸å‘ç”Ÿä¿®æ”¹

2. åŒå†™ï¼šå†™æ•°æ®çš„æ—¶å€™ï¼Œå¿…é¡»ä¹Ÿå»å†™ ESï¼›æ›´æ–°åˆ é™¤æ•°æ®åº“åŒç†ã€‚ï¼ˆäº‹åŠ¡ï¼šå»ºè®®å…ˆä¿è¯ MySQL å†™æˆåŠŸï¼Œå¦‚æœ ES å†™å¤±è´¥äº†ï¼Œå¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡ + æ—¥å¿— + å‘Šè­¦è¿›è¡Œæ£€æµ‹å’Œä¿®å¤ï¼ˆè¡¥å¿ï¼‰ï¼‰
3. ç”¨ Logstash æ•°æ®åŒæ­¥ç®¡é“ï¼ˆä¸€èˆ¬è¦é…åˆ kafka æ¶ˆæ¯é˜Ÿåˆ— + beats é‡‡é›†å™¨ï¼‰ï¼š

### Logstash

1. ä¸‹è½½å®‰è£…åŒ…

å®˜æ–¹æ–‡æ¡£ï¼š[Installing Logstash | Logstash Reference [7.17] | Elastic](https://www.elastic.co/guide/en/logstash/7.17/installing-logstash.html)

ä¸‹è½½åœ°å€ï¼šhttps://artifacts.elastic.co/downloads/logstash/logstash-7.17.9-windows-x86_64.zip

**ä¼ è¾“** å’Œ **å¤„ç†** æ•°æ®çš„ç®¡é“

![image20230330213705988](https://typora-1313423481.cos.ap-guangzhou.myqcloud.com/typora/image-20230330213705988.png)

å¥½å¤„ï¼šç”¨èµ·æ¥æ–¹ä¾¿ï¼Œæ’ä»¶å¤š

ç¼ºç‚¹ï¼šæˆæœ¬æ›´å¤§ã€ä¸€èˆ¬è¦é…åˆå…¶ä»–ç»„ä»¶ä½¿ç”¨ï¼ˆæ¯”å¦‚ kafkaï¼‰

## lostach mysql åŒæ­¥åˆ° es

[Jdbc input plugin | Logstash Reference [7.17] | Elastic](https://www.elastic.co/guide/en/logstash/7.17/plugins-inputs-jdbc.html)

```nginx
input {
  jdbc {
    jdbc_driver_library => "H:\Desktop\Java\yupi_project\yuso\ElasticStack\logstash-7.17.9\config\mysql-connector-java-8.0.29.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://localhost:3306/yu_search"
    jdbc_user => "root"
    jdbc_password => "root"
    statement => "SELECT * from post where updateTime > :sql_last_value and updateTime < now() order by updateTime desc"
    // åŠ¨æ€ç¼“å­˜çš„å­—æ®µ updatetime ï¼Œä¸‹æ¬¡æ¯”è¾ƒçš„æ˜¯æ­¤æ¬¡æœ€åä¸€æ¡æ•°æ®
    tracking_column => "updatetime"
    tracking_column_type => "timestamp"
    use_column_value => true
    // é¢„ç¼–è¯‘
    parameters => { "favorite_artist" => "Beethoven" }
    schedule => "*/5 * * * * *"
    jdbc_default_timezone => "Asia/Shanghai"
  }
}

filter {
    mutate {
        rename => {
            "updatetime" => "updateTime"
            "userid" => "userId"
            "createtime" => "createTime"
            "isdelete" => "isDelete"
        }
        remove_field => ["thumbnum", "favournum"]
    }
}

output {
  stdout { codec => rubydebug }
  elasticsearch {
    hosts => "http://localhost:9200"
    index => "post_v1"
    document_id => "%{id}"
  }
}
```

#### é…ç½® kibana å¯è§†åŒ–çœ‹æ¿

1. åˆ›å»ºç´¢å¼•
2. å¯¼å…¥æ•°æ®
3. åˆ›å»ºç´¢å¼•æ¨¡å¼
4. é€‰æ‹©å›¾æ ‡ã€æ‰˜æ‹‰æ‹½
5. ä¿å­˜
